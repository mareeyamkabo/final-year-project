<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Dashboard</title>
  <style>
    :root {
      --primary: #4a90e2;
      --danger: #e74c3c;
      --success: #2ecc71;
      --warning: #f1c40f;
      --info: #3498db;

      /* Light mode defaults */
      --bg: #f4f7fb;
      --darker: #ffffff;
      --card: #ffffff;
      --text: #222;
      --gray: #999;
    }

    body.dark {
      --bg: #181818;
      --darker: #1e1e1e;
      --card: #242424;
      --text: #f9f9f9;
      --gray: #888;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
    }

    header {
      background: var(--darker);
      color: var(--text);
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid var(--gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toggle-btn {
      background: var(--primary);
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }

    .tabs {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: var(--darker);
      margin: 0 5px;
      border-radius: 20px;
      font-weight: 600;
      color: var(--gray);
      transition: 0.3s;
    }
    .tab.active {
      background: var(--primary);
      color: white;
    }

    .container {
      width: 90%;
      max-width: 1100px;
      margin: auto;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      overflow: hidden;
      transition: transform 0.2s, background 0.3s ease;
    }
    .card:hover { transform: translateY(-4px); }

    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      background: #333;
    }

    .card-content {
      padding: 15px;
    }

    .status-pill {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      color: white;
      margin-top: 8px;
    }
    .pending { background: var(--warning); color: black; }
    .approved { background: var(--success); }
    .resolved { background: var(--info); }

    .form-section {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin: 20px 0;
      transition: background 0.3s ease;
    }

    .form-section input,
    .form-section select,
    .form-section button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid var(--gray);
      background: var(--darker);
      color: var(--text);
      font-size: 14px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .form-section button {
      background: var(--primary);
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    .form-section button:hover { background: #357ABD; }

    .error { color: var(--danger); text-align: center; margin-top: 10px; }
  </style>
</head>
<body class="dark">
  <header>
    <h1>Student Dashboard</h1>
    <button class="toggle-btn" onclick="toggleDarkMode()">‚òÄÔ∏è Light</button>
  </header>

  <div class="container">

    <!-- Submission Form -->
    <div class="form-section">
      <h2>Submit Lost or Found Item</h2>
      <form id="itemForm" enctype="multipart/form-data">
        <input type="text" id="itemName" placeholder="Item Name" required />
        <input type="text" id="itemDescription" placeholder="Description" required />
        <input type="text" id="itemLocation" placeholder="Location" required />
        <input type="date" id="itemDateLost" required />
        <select id="itemType" required>
          <option value="">Type</option>
          <option value="found">Found</option>
          <option value="missing">Missing</option>
        </select>
        <input type="file" id="itemImage" accept="image/*" />
        <button type="submit">Submit Item</button>
      </form>
      <div id="error" class="error"></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="showTab('all')">All Items</div>
      <div class="tab" onclick="showTab('mine')">My Submissions</div>
    </div>

    <!-- Grid -->
    <div id="itemsGrid" class="grid"></div>
  </div>

  <script>
    const API_URL = "http://localhost:5000/api/items";
    const UPLOADS_URL = "http://localhost:5000/uploads/";

    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    let items = [];
    let activeTab = "all";
    let currentUserId = null;

    function parseJwt(token) {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch (e) {
        return null;
      }
    }
    const decoded = parseJwt(token);
    if (decoded) currentUserId = decoded.id;

    function showTab(tab) {
      activeTab = tab;
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelector(`.tab:nth-child(${tab === "all" ? 1 : 2})`).classList.add("active");
      renderItems();
    }

    function renderItems() {
      const grid = document.getElementById("itemsGrid");
      grid.innerHTML = "";

      let filtered = [];
      if (activeTab === "all") {
        filtered = items.filter(i => i.status === "approved" || i.status === "resolved");
      } else {
        filtered = items.filter(i => i.uploaderId === currentUserId);
      }

      if (filtered.length === 0) {
        grid.innerHTML = "<p>No items to display.</p>";
        return;
      }

      filtered.forEach(item => {
        grid.innerHTML += `
          <div class="card">
            ${item.image ? `<img src="${UPLOADS_URL + item.image}" alt="Item">` : `<img src="https://via.placeholder.com/300x180/333/fff?text=No+Image" />`}
            <div class="card-content">
              <h3>${item.name}</h3>
              <p>${item.description}</p>
              <small>üìç ${item.location}</small><br/>
              <span class="status-pill ${item.status}">${item.status}</span>
            </div>
          </div>
        `;
      });
    }

    async function fetchItems() {
      try {
        const res = await fetch(API_URL, {
          headers: { Authorization: `Bearer ${token}` }
        });
        items = await res.json();
        renderItems();
      } catch (err) {
        console.error("Error fetching items:", err);
      }
    }

    document.getElementById("itemForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = new FormData();
      formData.append("name", document.getElementById("itemName").value);
      formData.append("description", document.getElementById("itemDescription").value);
      formData.append("location", document.getElementById("itemLocation").value);
      formData.append("dateLost", document.getElementById("itemDateLost").value);
      formData.append("type", document.getElementById("itemType").value);
      formData.append("status", "pending");

      const fileInput = document.getElementById("itemImage");
      if (fileInput.files.length > 0) formData.append("image", fileInput.files[0]);

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });
        if (!res.ok) {
          const err = await res.json();
          document.getElementById("error").innerText = err.message || "Failed to submit.";
          return;
        }
        document.getElementById("itemForm").reset();
        document.getElementById("error").innerText = "";
        fetchItems();
      } catch (err) {
        document.getElementById("error").innerText = "Something went wrong.";
      }
    });

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
      document.querySelector(".toggle-btn").innerText = 
        document.body.classList.contains("dark") ? "‚òÄÔ∏è Light" : "üåô Dark";
    }

    fetchItems();
  </script>
</body>
</html>

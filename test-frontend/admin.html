<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <style>
    :root {
      --primary: #4a90e2;
      --dark: #1e1e2f;
      --bg: #f4f7fb;
      --white: rgba(255, 255, 255, 0.8);
      --danger: #e74c3c;
      --success: #27ae60;
      --warning: #f39c12;
      --info: #3498db;
      --gray: rgba(255,255,255,0.3);
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #e0eafc, #cfdef3);
      margin: 0;
      padding: 40px;
      color: var(--dark);
    }

    body.dark {
      background: linear-gradient(135deg, #141E30, #243B55);
      color: var(--white);
    }

    .container {
      max-width: 1200px;
      margin: auto;
      background: var(--white);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      backdrop-filter: blur(12px);
    }

    body.dark .container {
      background: rgba(40, 44, 52, 0.7);
    }

    h1, h2 {
      text-align: center;
      margin: 0;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    h2 {
      font-size: 16px;
      color: var(--primary);
      margin-bottom: 20px;
    }

    .dark h2 {
      color: #9ecbff;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 25px;
      justify-content: center;
    }

    .toolbar input,
    .toolbar select,
    .toolbar button {
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 50px;
      border: 1px solid var(--gray);
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(8px);
      outline: none;
      transition: all 0.2s ease;
    }

    body.dark .toolbar input,
    body.dark .toolbar select {
      background: rgba(255,255,255,0.1);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
    }

    button {
      border: none;
      cursor: pointer;
      color: #fff;
      font-weight: 500;
      transition: transform 0.2s;
    }

    button:hover {
      transform: scale(1.05);
    }

    .btn-create { background: var(--primary); }
    .btn-edit { background: var(--success); }
    .btn-toggle { background: var(--info); }
    .btn-delete { background: var(--danger); }
    .btn-darkmode { background: #6c5ce7; }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
    }

    th, td {
      padding: 14px;
      text-align: center;
      font-size: 14px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    th {
      background: var(--primary);
      color: #fff;
    }

    tr:hover { background: rgba(74,144,226,0.05); }
    body.dark tr:hover { background: rgba(255,255,255,0.05); }

    .badge {
      padding: 6px 14px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: bold;
      text-transform: capitalize;
      color: #fff;
    }

    .badge.pending { background: var(--warning); }
    .badge.approved { background: var(--success); }
    .badge.resolved { background: var(--info); }

    img.item-image {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 12px;
      border: 2px solid var(--gray);
      cursor: pointer;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 6px;
    }

    .error {
      color: var(--danger);
      margin-bottom: 15px;
      text-align: center;
    }

    /* --- Custom Modal --- */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .modal.hidden { display: none; }
    .modal-content {
      background: var(--white);
      padding: 20px 30px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    body.dark .modal-content {
      background: rgba(40,44,52,0.9);
      color: #fff;
    }
    .modal-actions {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    .btn-confirm {
      background: var(--success);
      padding: 8px 20px;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
    }
    .btn-cancel {
      background: var(--danger);
      padding: 8px 20px;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
    }

    /* Full image modal override */
    #imageModal .modal-content {
      background: none;
      box-shadow: none;
    }
    #imageModal img {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Welcome to Lost & Found System</h1>
    <h2>Admin Dashboard - FUD</h2>
    <div id="error" class="error"></div>

    <form id="itemForm" enctype="multipart/form-data" class="toolbar">
      <input type="text" id="itemName" placeholder="Item Name" required />
      <input type="text" id="itemDescription" placeholder="Description" required />
      <input type="text" id="itemLocation" placeholder="Location" required />
      <input type="date" id="itemDateLost" required />
      <select id="itemType" required>
        <option value="">Type</option>
        <option value="found">Found</option>
        <option value="missing">Missing</option>
      </select>
      <select id="itemStatus" required>
        <option value="">Status</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="resolved">Resolved</option>
      </select>
      <input type="file" id="itemImage" accept="image/*" />
      <button type="submit" class="btn-create">Create</button>
      <button type="button" class="btn-darkmode" onclick="toggleDarkMode()">🌙</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>ID</th><th>Image</th><th>Name</th><th>Description</th>
          <th>Location</th><th>Date Lost</th><th>Status</th><th>Type</th>
          <th>Uploader</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="itemsTable"></tbody>
    </table>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal hidden">
    <div class="modal-content">
      <p id="confirmMessage">Are you sure?</p>
      <div class="modal-actions">
        <button id="confirmYes" class="btn-confirm">Yes</button>
        <button id="confirmNo" class="btn-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Image Viewer Modal -->
  <div id="imageModal" class="modal hidden">
    <div class="modal-content" style="max-width:90%; max-height:90%; padding:0; background:none; box-shadow:none;">
      <img id="fullImage" src="" alt="Full Item" />
      <div style="text-align:center; margin-top:10px;">
        <button onclick="closeImage()" class="btn-cancel">Close</button>
      </div>
    </div>
  </div>

  <script>
    function toggleDarkMode() { document.body.classList.toggle("dark"); }

    const token = localStorage.getItem("token");
    if (!token) window.location.href = "login.html";

    let editMode = false;
    let editItemId = null;

    // Custom confirmation modal
    function customConfirm(message) {
      return new Promise((resolve) => {
        const modal = document.getElementById("confirmModal");
        const msg = document.getElementById("confirmMessage");
        const yesBtn = document.getElementById("confirmYes");
        const noBtn = document.getElementById("confirmNo");

        msg.innerText = message;
        modal.classList.remove("hidden");

        yesBtn.onclick = () => { modal.classList.add("hidden"); resolve(true); };
        noBtn.onclick = () => { modal.classList.add("hidden"); resolve(false); };
      });
    }

    function showImage(src) {
      const modal = document.getElementById("imageModal");
      const fullImage = document.getElementById("fullImage");
      fullImage.src = src;
      modal.classList.remove("hidden");
    }

    function closeImage() {
      document.getElementById("imageModal").classList.add("hidden");
    }

    async function fetchItems() {
      const res = await fetch("http://localhost:5000/api/items", {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      const tbody = document.getElementById("itemsTable");
      tbody.innerHTML = "";
      data.forEach(item => {
        const uploader = item.User?.name || "N/A";
        const date = item.dateLost ? new Date(item.dateLost).toLocaleDateString() : "N/A";
        const imageUrl = item.image ? `http://localhost:5000/uploads/${item.image}` : null;
        const imageHtml = imageUrl
          ? `<img src="${imageUrl}" class="item-image" onclick="showImage('${imageUrl}')" />`
          : "No Image";

        tbody.innerHTML += `
          <tr>
            <td>${item.id}</td>
            <td>${imageHtml}</td>
            <td>${item.name}</td>
            <td>${item.description}</td>
            <td>${item.location}</td>
            <td>${date}</td>
            <td><span class="badge ${item.status}">${item.status}</span></td>
            <td>${item.type}</td>
            <td>${uploader}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-edit" onclick="loadEdit(${item.id}, '${item.name}', '${item.description}', '${item.location}', '${item.dateLost?.split('T')[0]}', '${item.type}', '${item.status}')">Edit</button>
                <button class="btn-toggle" onclick="toggleStatus(${item.id}, '${item.status}')">Toggle</button>
                <button class="btn-delete" onclick="deleteItem(${item.id})">Delete</button>
              </div>
            </td>
          </tr>`;
      });
    }

    function loadEdit(id, name, description, location, dateLost, type, status) {
      editMode = true;
      editItemId = id;
      document.getElementById("itemName").value = name;
      document.getElementById("itemDescription").value = description;
      document.getElementById("itemLocation").value = location;
      document.getElementById("itemDateLost").value = dateLost;
      document.getElementById("itemType").value = type;
      document.getElementById("itemStatus").value = status;
      document.querySelector(".btn-create").innerText = "Update";
    }

    async function toggleStatus(id, currentStatus) {
      const next = currentStatus === "pending"
        ? "approved"
        : currentStatus === "approved"
          ? "resolved"
          : "pending";

      const confirmed = await customConfirm(
        `⚠️ Change status from "${currentStatus}" to "${next}"?`
      );
      if (!confirmed) return;

      const res = await fetch(`http://localhost:5000/api/items/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({ status: next })
      });
      if (!res.ok) {
        const err = await res.json();
        document.getElementById("error").innerText = err.message || "Failed to update status.";
        return;
      }
      fetchItems();
    }

    async function deleteItem(id) {
      const confirmed = await customConfirm("❌ Are you sure you want to DELETE this item?");
      if (!confirmed) return;

      const res = await fetch(`http://localhost:5000/api/items/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) {
        const err = await res.json();
        document.getElementById("error").innerText = err.message || "Failed to delete item.";
        return;
      }
      fetchItems();
    }

    document.getElementById("itemForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const formData = new FormData();
      formData.append("name", document.getElementById("itemName").value);
      formData.append("description", document.getElementById("itemDescription").value);
      formData.append("location", document.getElementById("itemLocation").value);
      formData.append("dateLost", document.getElementById("itemDateLost").value);
      formData.append("type", document.getElementById("itemType").value);
      formData.append("status", document.getElementById("itemStatus").value || "pending");

      const fileInput = document.getElementById("itemImage");
      if (fileInput.files.length > 0) formData.append("image", fileInput.files[0]);

      const url = editMode
        ? `http://localhost:5000/api/items/${editItemId}`
        : "http://localhost:5000/api/items";
      const method = editMode ? "PUT" : "POST";

      const res = await fetch(url, { method, headers: { Authorization: `Bearer ${token}` }, body: formData });
      if (!res.ok) {
        const err = await res.json();
        document.getElementById("error").innerText = err.message || "Something went wrong.";
        return;
      }
      e.target.reset();
      editMode = false;
      editItemId = null;
      document.querySelector(".btn-create").innerText = "Create";
      fetchItems();
    });

    fetchItems();
  </script>
</body>
</html>
